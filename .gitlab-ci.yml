stages:
  - scan
  - review
  - publish
  - security

# --------------------
# Scan versions
# --------------------
scan_versions:
  stage: scan
  image: python:3.12
  script:
    - ./tracker/fetch_versions.sh
    - python3 tracker/compare_versions.py
  artifacts:
    paths:
      - tracker/output/

# --------------------
# Manual approval gate
# --------------------
approval_gate:
  stage: review
  when: manual
  allow_failure: false

publish_to_confluence:
  stage: publish
  image: alpine:latest
  script:
    - apk add --no-cache curl jq
    - ./tracker/publish_to_confluence.sh
  needs:
    - scan_versions

publish_existing_page:
  stage: publish
  image: alpine:latest
  script:
    - apk add --no-cache curl jq
    - ./tracker/update_confluence_page.sh
  need:
    - scan_versions

  publish_child_report:
    stage: publish
    image: alpine:latest
    script:
      - apk add --no-cache curl jq
      - ./tracker/create_child_report.sh
    needs:
      - scan_versions
    when: manual

# --------------------
# Publish NEW child report (primary path)
# --------------------
publish_child_report:
  stage: publish
  image: alpine:latest
  needs:
    - scan_versions
    - approval_gate
  script:
    - apk add --no-cache bash curl jq
    - ./tracker/create_child_report.sh

# --------------------
# Update existing page (optional / manual)
# --------------------
publish_existing_page:
  stage: publish
  image: alpine:latest
  needs:
    - scan_versions
    - approval_gate
  when: manual
  script:
    - apk add --no-cache bash curl jq
    - ./tracker/update_confluence_page.sh

# --------------------
# Security (optional)
# --------------------
variables:
  SECRET_DETECTION_ENABLED: "true"

secret_detection:
  stage: secret-detection

  stage: security
