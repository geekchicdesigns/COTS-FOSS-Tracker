stages:
  - scan
  - publish

# These should already exist in GitLab → CI/CD → Variables
# ARGOCD_SERVER=https://host.docker.internal:8081
# ARGOCD_TOKEN=<JWT>

scan_versions:
  stage: scan
  image: alpine:latest
  tags: [docker]
  script:
    - apk add --no-cache curl jq bash
    - mkdir -p tracker/output

    # Fetch all ArgoCD applications (source of truth)
    - |
      curl -sk \
        -H "Authorization: Bearer $ARGOCD_TOKEN" \
        "$ARGOCD_SERVER/api/v1/applications" \
        > tracker/output/argocd_apps.json

    # Optional sanity check (non-fatal)
    - jq '.' tracker/output/argocd_apps.json

  artifacts:
    when: always
    paths:
      - tracker/output/argocd_apps.json
    expire_in: 1 hour

publish_child_report:
  stage: publish
  image: alpine:latest
  variables:
    GIT_STRATEGY: none
  tags: [docker]
  dependencies:
    - scan_versions
  script:
    - apk add --no-cache git bash curl jq python3

    - git clone http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab/platform/cots-foss-tracker.git
    - cd cots-foss-tracker

    # tracker/output/argocd_apps.json is already present via artifacts
    - python3 ./tracker/compare_versions.sh
    - bash ./tracker/create_child_report.sh tracker/output/versions.json
